<html>
<head>
	<!-- Meta -->
	<meta charset="UTF-8">
	<title>Shinto</title>
	<!-- Styles -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<!-- Javascript -->
	<script src="http://fb.me/react-with-addons-0.12.2.min.js"></script>
	<script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
	<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
	<script src="http://underscorejs.org/underscore-min.js"></script>
</head>
<body>
	<header>
		<strong>Shinto - Another Kanban Clone</strong>
	</header>
	<main class="container-fluid">
		<section id="controls">
			<!-- Sorting Options -->
			<!--
			<ul id="sorting-options" class="list-unstyled">
				<li><span class="glyphicon glyphicon-th"></span></li>
				<li><span class="glyphicon glyphicon-menu-hamburger"></span></li>
			</ul>
			 -->
			<!-- Add Activities -->
			<button class="btn btn-success">
				+ <b>Add Activity</b>
			</button>
		</section>
		<section id="application"></section>
	</main>
	<!-- React Application -->
	<script type="text/jsx">
		var Server = {
			_data: $.get('http://localhost:8000/api/v1/board/', function(data) {
				return data;
			}),

			loadData: function(callback) {
				setTimeout(callback.bind(null, this._data), 500);
			},

			updateBoard: function(board) {
				// 
			},

			updateCard: function(card) {
				// 
			},

			updateActivity: function(activity) {
				// 
			},

			updateComment: function(comment) {
				// 
			},
		};

		var Activity = React.createClass({

			mixins: [React.addons.LinkedStateMixin],

			getInitialState: function() {
				return {
					position: this.props.position,
					name: this.props.activity.name,
				}
			},

			render: function() {
				return (
					<li className='activity'>
						<div className="activity-name">
							Name:
							<input 
								ref="name"
								defaultValue={this.props.name}
								valueLink={this.linkState('name')}
							/>
						</div>
						<div className="activity-position">
							Position:
							<input 
								ref="position"
								defaultValue={this.props.position}
								valueLink={this.linkState('position')}
							/>
						</div>
						<button 
							className="activity-save"
							onClick={this.handleSave}
						>
							Save
						</button>
					</li>
				)
			},

			handleSave: function() {
				var valueToSave = _.clone(this.props.activity);
				valueToSave.position = parseInt(this.refs.position.getDOMNode().value, 10);
				valueToSave.name = this.refs.name.getDOMNode().value.trim();
				this.props.onChange(valueToSave);
			}
		});

		var Card = React.createClass({
			getInitialState: function() {
				return {
					activities: this.props.activities,
				}
			},
			
			handleActivityChanged: function(activity) {
				var activities = _.clone(this.state.activities);
				var activity_index = _.findIndex(activities, function(current) {
					return current.id === activity.id
				});

				if (activity_index != -1) {
					activities[activity_index] = activity;
					
					activities.sort(function(a, b) {
						return a.position - b.position;
					});

					this.setState({
						activities: activities,
					});

					// Server.updateActivity(activity);
				}
			},

			render: function() {
				var activities = this.state.activities.map(function(activity) {
					return (
						<Activity 
							activity={activity['name']}
							position={activity['position']}
							card={activity['card']}
							onChange={this.handleActivityChanged}
						/>
					)
				});
				return (
					<li className='card'>
						<h4>{this.props.card}</h4>
						<ul>
							{activities}
						</ul>
					</li>
				)
			}
		});

		var Board = React.createClass({
			getInitialState: function() {
				return {
					cards: this.props.cards,
				}
			},

			render: function() {
				var cards = this.state.cards.sort(function(a, b) {
					return parseFloat(a.id) - parseFloat(b.id);
				}).map(function(card) {
					return (
						<Card 
							card={card['name']} 
							activities={card['activities']} 
						/>
					)
				});
				return (
					<section className='row'>
						<h3 className='board-title'>{this.props.board}</h3>
						<ul>
							{cards}
						</ul>
					</section>
				)
			}
		});

		var App = React.createClass({
			getInitialState: function() {
				return {
					boards: [],
				};
			},

			componentDidMount: function() {
				this.loadFromServer();
			},

			loadFromServer: function() {
				Server.loadData(this.handleServerLoaded);
			},

			handleServerLoaded: function(boards) {
				this.setState({
					boards: JSON.parse(boards['responseText']),
				});
			},

			render: function() {
				var nodes = this.state.boards;
				var boards = nodes.map(function(board) {
					return (
						<Board 
							board={board['name']} 
							cards={board['cards']} 
						/>
					)
				});
				return (
					<div>
						{boards}
					</div>
				)
			}
		});

		React.render(<App />, document.getElementById('application'));
	</script>
</body>
</html>